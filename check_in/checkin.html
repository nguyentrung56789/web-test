<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#111" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>Check-in (No-CORS Form POST, GPS an to√†n)</title>
<style>
  :root{ --bar-h:76px }

  /* Reset c∆° b·∫£n */
  html,body{height:100%;margin:0}
  body{
    background:#000;color:#fff;
    font-family:system-ui,Segoe UI,Roboto,Arial;
    overflow:hidden;
    min-height:-webkit-fill-available; /* iOS */
  }

  /* ==== Camera stage ==== */
  .stage{
    position:fixed;left:0;right:0;top:0; /* chi·ªÅu cao x·ª≠ l√Ω b√™n d∆∞·ªõi */
    display:flex;align-items:center;justify-content:center;
    background:#000;z-index:1;
    height:calc(100vh - var(--bar-h));
  }
  @supports (height: 100dvh){
    .stage{ height:calc(100dvh - var(--bar-h)); }
  }

  video,canvas{
    width:100%;height:100%;object-fit:cover;display:block;
    pointer-events:none;background:#000;
  }

  /* ==== Bottom bar ==== */
  .bar{
    position:fixed;left:0;right:0;bottom:0;height:var(--bar-h);
    background:#111;border-top:1px solid rgba(255,255,255,.08);
    display:flex;gap:10px;align-items:center;justify-content:center;
    padding:10px calc(12px + env(safe-area-inset-right))
             calc(10px + env(safe-area-inset-bottom))
             calc(12px + env(safe-area-inset-left));
    z-index:50;
  }
  .btn{
    appearance:none;border:none;border-radius:12px;
    padding:12px 16px;font-weight:700;font-size:16px;
    cursor:pointer;white-space:nowrap;
  }
  .btn-blue{background:#2563eb;color:#fff}
  .btn-green{background:#10b981;color:#fff}
  .btn-gray{background:#374151;color:#fff}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  /* ==== Toast ==== */
  #toast{
    position:fixed;left:50%;top:0;transform:translate(-50%,-120%);
    opacity:0;background:#e0f2fe;color:#075985;
    border:1px solid #38bdf8;padding:10px 14px;border-radius:12px;
    font-weight:700;transition:transform .25s ease,opacity .25s ease;
    z-index:99; box-shadow:0 6px 22px rgba(0,0,0,.25);
  }

  /* ==== Map Sheet ==== */
  #mapSheet{
    position:fixed;left:0;right:0;bottom:0;top:0;
    background:#000;border-top:2px solid #1e3a8a;
    transform:translateY(100%);
    transition:transform .35s ease;
    z-index:90; display:flex;flex-direction:column;
  }
  #mapSheet.open{transform:translateY(0);}

  #mapHeader{
    background:#1e3a8a;color:#fff;padding:12px 16px;text-align:center;
    font-weight:700;cursor:pointer;user-select:none;
  }
  #mapHeader .grab{display:inline-block;width:42px;height:5px;border-radius:3px;background:#ffffff55;margin:0 10px 2px 0;vertical-align:middle}
  #mapFrame{flex:1;border:none;display:block;width:100%;}
</style>
</head>
<body>
  <!-- Camera -->
  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" aria-hidden="true" style="display:none"></canvas>
  </div>

  <!-- Bottom bar -->
  <div class="bar" id="bar">
    <button id="btnStart" class="btn btn-blue">B·∫≠t camera</button>
    <button id="btnShot" class="btn btn-green" disabled>üì∏ Ch·ª•p & g·ª≠i</button>
    <button id="btnMap" class="btn btn-gray" style="margin-left:auto">üó∫Ô∏è B·∫£n ƒë·ªì</button>
    <button id="btnDownload" class="btn btn-gray" style="display:none">‚¨áÔ∏è T·∫£i ·∫£nh</button>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>
  <iframe id="sink" name="sink" style="display:none"></iframe>

  <!-- Map full-screen -->
  <div id="mapSheet" aria-hidden="true">
    <div id="mapHeader" title="B·∫•m ƒë·ªÉ ƒë√≥ng">
      <span class="grab"></span>üó∫Ô∏è B·∫£n ƒë·ªì tuy·∫øn ‚Äî b·∫•m ƒë·ªÉ ƒë√≥ng
    </div>
    <iframe src="map_tuyen.html" id="mapFrame" referrerpolicy="no-referrer"></iframe>
  </div>

<script>
/* ========= CONFIG ========= */
const WEBHOOK_URL = "https://dhsybbqoe.datadex.vn/webhook/hoadon";
const TARGET_W = 900, TARGET_H = 1600;  // ·∫£nh chu·∫©n portrait 9:16

/* ========= DOM ========= */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnStart = document.getElementById('btnStart');
const btnShot  = document.getElementById('btnShot');
const btnDl    = document.getElementById('btnDownload');
const toastEl  = document.getElementById('toast');
const mapSheet = document.getElementById('mapSheet');
const mapHeader= document.getElementById('mapHeader');
const btnMap   = document.getElementById('btnMap');
const bar      = document.getElementById('bar');

let stream = null;

/* ========= Toast ========= */
function toast(t,type='info',ms=2400){
  toastEl.textContent=t;
  toastEl.style.opacity='1'; toastEl.style.transform='translate(-50%,10px)';
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>{
    toastEl.style.opacity='0';
    toastEl.style.transform='translate(-50%,-120%)';
  },ms);
}

/* ========= Camera ========= */
async function startCam(){
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    const base = { video:{ width:{ideal:1080}, height:{ideal:1920} }, audio:false };

    // ∆Øu ti√™n camera sau: th·ª≠ ch·∫ø ƒë·ªô "exact" (m·∫°nh) -> fallback "ideal"
    let c = structuredClone(base);
    c.video.facingMode = { exact: 'environment' };
    try {
      stream = await navigator.mediaDevices.getUserMedia(c);
    } catch {
      c = structuredClone(base);
      c.video.facingMode = { ideal: 'environment' };
      stream = await navigator.mediaDevices.getUserMedia(c);
    }

    video.srcObject = stream;
    await new Promise(r=> video.onloadedmetadata = r); // ƒë·∫£m b·∫£o c√≥ videoWidth/Height
    btnShot.disabled = false;
    toast('ƒê√£ b·∫≠t camera','ok');
  }catch(e){
    btnShot.disabled = true;
    toast('L·ªói camera: '+ (e?.message || e), 'err', 4200);
  }
}

function stopCam(){
  if(stream){
    try{ stream.getTracks().forEach(t=>t.stop()); }catch{}
    stream=null; video.srcObject=null;
  }
}

function drawToCanvas(){
  const fw=video.videoWidth, fh=video.videoHeight;
  if(!fw || !fh) return;
  const ar=fw/fh, desired=TARGET_W/TARGET_H;
  let sx=0, sy=0, sw=fw, sh=fh;
  if(ar>desired){ sw=fh*desired; sx=(fw-sw)/2; }  // crop ngang
  else{ sh=fw/desired; sy=(fh-sh)/2; }            // crop d·ªçc
  canvas.width=TARGET_W; canvas.height=TARGET_H;
  canvas.getContext('2d').drawImage(video,sx,sy,sw,sh,0,0,TARGET_W,TARGET_H);
}

function getGPSOnce(){
  return new Promise(r=>{
    if(!('geolocation' in navigator)) return r(null);
    navigator.geolocation.getCurrentPosition(
      p=>r({lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy}),
      _=>r(null),
      {enableHighAccuracy:true,timeout:10000,maximumAge:0}
    );
  });
}

function postForm(url,f){
  let form=document.getElementById('hiddenForm');
  if(!form){
    form=document.createElement('form');
    form.id='hiddenForm'; form.method='POST'; form.target='sink';
    form.style.display='none'; document.body.appendChild(form);
  }
  form.action=url; form.innerHTML='';
  for(const[k,v] of Object.entries(f)){
    const i=document.createElement('input');
    i.type='hidden'; i.name=k; i.value=v??''; form.appendChild(i);
  }
  form.submit();
}

/* ========= Events ========= */
btnStart.onclick = startCam;

btnShot.onclick = async()=>{
  if(!stream){ toast('Ch∆∞a b·∫≠t camera','err'); return; }
  drawToCanvas();
  const mime='image/jpeg';           // ƒë·ªïi sang 'image/png' n·∫øu mu·ªën PNG
  const dataUrl=canvas.toDataURL(mime,0.85);
  const gps=await getGPSOnce();
  const payload={
    action:'checkin',
    gps_json:JSON.stringify(gps),
    image_mime:mime,
    image_b64:dataUrl.split(',')[1]
  };
  postForm(WEBHOOK_URL+'?action=checkin', payload);
  toast('ƒê√£ g·ª≠i webhook','ok');
};

btnDl.onclick = ()=>{
  drawToCanvas();
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/jpeg',0.92);
  a.download='checkin.jpg';
  a.click();
};

/* ==== M·ªü/ƒë√≥ng b·∫£n ƒë·ªì: t·∫Øt/b·∫≠t camera ƒë·ªÉ ti·∫øt ki·ªám pin ==== */
btnMap.addEventListener('click',()=>{
  stopCam();
  bar.style.display='none';
  mapSheet.classList.add('open');
  mapSheet.setAttribute('aria-hidden','false');
});
mapHeader.addEventListener('click',()=>{
  mapSheet.classList.remove('open');
  mapSheet.setAttribute('aria-hidden','true');
  bar.style.display='flex';
  startCam();
});

/* ==== Auto xin quy·ªÅn & t·ªëi ∆∞u mobile ==== */
(async()=>{
  try{
    if (navigator.permissions?.query) {
      try{
        const camPerm = await navigator.permissions.query({name:'camera'});
        camPerm.onchange = () => { if(camPerm.state==='granted' && !stream) startCam(); };
      }catch{}
      try{
        const geoPerm = await navigator.permissions.query({name:'geolocation'});
        if(geoPerm.state==='granted'){ navigator.geolocation.getCurrentPosition(()=>{},()=>{}); }
      }catch{}
    }
  }catch(e){ console.warn('Permission check failed',e); }
})();

/* ==== Khi tab ·∫©n/hi·ªán ho·∫∑c xoay m√°y ==== */
document.addEventListener('visibilitychange',()=>{
  if(document.hidden) stopCam();
  else if (!mapSheet.classList.contains('open')) startCam();
});
window.addEventListener('orientationchange',()=>{
  if(stream) drawToCanvas();
});
</script>
</body>
</html>
